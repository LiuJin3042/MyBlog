# NAT

公有IPv4地址有限, 为了节省地址发明. 内网流量传到外网, 通过路由器包装, 路由器会把NAT地址池中的一个地址拿来替换内网地址. 这样外网看来是一个公有地址在通讯. 

## NAT 操作

NAT有这些术语

* 内部地址: 经过NAT转换设备的地址
* 外部地址: 目标设备的地址
* 本地地址: 内网出现的地址
* 全局地址: 出现在外网

推广

* 内部本地: 内网出现的要被转换的地址
* 内部全局: 内网地址转换后的地址
* 外部本地: 目标设备的地址在内网的样子(不变)
* 外部全局: 目标设备的地址在外网的样子(==外部本地)

### 工作方式

* 内部主机使用内部本地地址发送一个数据包
* NAT路由器接到数据包
* NAT路由器吧数据包的内部本地地址替换为内部全局地址
* 发往外部全局地址
* 收到回信
* 把内部全局地址按照映射表转换为内部本地地址
* 发送回去

### NAT类型

* 静态NAT: 本地地址-全局地址, 一对一映射

* 动态NAT: 多对多. 100内部, 10个全局, 可以按需转换. 

* 端口地址转换PAT: 多对一. 根据端口转发. 重复次数高达65536次

  一般来说只有一个内部全局地址.

  通信流程

  * 发起TCP/IP会话
  * 生成一个 TCP 或 UDP 源端口值或专门为 ICMP 分配的查询 ID来标记会话
  * 用端口号确定转发

  如果源端口别占用, 会从相应端口组( 0–511、512–1023 或 1024–65535 )分配第一个可用的端口号. **新的端口号是对于内部全局地址而言的, 内部本地地址不必更改端口号**

  

### NAT优势

* 节省地址
* 增强连接公网的灵活性, 可以实施多池/备用池/负载均衡池
* 更改公共IPv4地址不必对本地地址重新编址, 为内部网络编址方案提供了一致性 
* 隐藏内部地址

### NAT缺陷

* 转发延迟
* 端到端编址的丢失, 与目的IPv4地址有关的协议将不可用. 例如数字签名
* 端到端IPv4可追溯性缺失, 排除故障困难
* 隧道协议复杂. IPsec不可用

* 外网发起的TCP链接的一些服务或无状态协议可能中断

## 配置NAT

### 静态NAT

配置 192.168.10.254 映射到 209.165.201.5 

```
(config)
ip nat inside source static 192.168.10.254 209.168.201.5 // 静态nat映射
interface s0/0/0
(config-if)
ip addr 192.168.1.2 255.255.255.252 // 分配端口ip
ip nat inside // 配置为nat内部接口
exit
(config)
inter s0/1/0
(config-if)
ip addr 209.165.200.1 255.255.255.252
ip nat outside
```

